<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Boss Timers — Manual & Scheduled</title>
<style>
:root{
  --bg:#0d1117;--fg:#e6edf3;--accent:#58a6ff;--card-bg:#161b22;
  --expired:#f85149;--warn:#f0c443
}
body.light{--bg:#f8f8f8;--fg:#111;--accent:#007777;--card-bg:#fff}
body{background:var(--bg);color:var(--fg);font-family:Inter,system-ui,monospace;margin:0}
.container{max-width:1100px;margin:0 auto;padding:12px}
header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--card-bg);border-bottom:1px solid rgba(255,255,255,0.03)}
.header-left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.header-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--fg)}
.user-badge{font-size:0.95rem;opacity:0.95}
main{padding:16px}
h2{color:var(--accent);margin:6px 0}
.timer-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-top:12px}
.card{background:var(--card-bg);border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 24px rgba(0,0,0,0.5)}
.card > * { margin-bottom: 6px; }
.card > *:last-child { margin-bottom: 0; }
.label{font-weight:700;margin-bottom:8px}
.clock{font-size:1.25rem;font-weight:700;margin-bottom:6px}
.datetime{font-size:0.85rem;color:var(--accent);margin-bottom:6px}
.small{font-size:0.85rem;color:rgba(255,255,255,0.7)}
.warning{border-color:var(--warn);color:var(--warn)}
.expired{border-color:var(--expired);color:var(--expired)}
input[type="text"],input[type="number"]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--fg)}
#visitorLog{background:var(--card-bg);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);max-height:200px;overflow:auto}
#confirmModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center}
#confirmBox{background:var(--card-bg);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);text-align:center}
#userModal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999}
#userModalContent{background:var(--card-bg);padding:20px;border-radius:10px;text-align:center;width:300px}
/* Timer glow effects */
.timer-running {
  box-shadow: 0 0 12px 2px rgba(88,166,255,0.8);
  border-color: var(--accent);
}
.timer-ended {
  box-shadow: 0 0 12px 2px rgba(46,204,113,0.9);
  border-color: #2ecc71;
}
.timer-today {
  box-shadow: 0 0 12px 2px rgba(46,204,113,0.9);
  border-color: #2ecc71;
}
@media(max-width:600px){
  header{flex-direction:column;align-items:stretch}
  .header-left, .header-right {justify-content: space-between;margin-bottom: 8px}
  section > div[style*="margin-bottom:12px"] { flex-direction: column; gap: 6px; }
  section > div[style*="margin-bottom:12px"] input, section > div[style*="margin-bottom:12px"] button {width: 100%; box-sizing: border-box;}
  .clock{font-size:1rem}
  .datetime,.endtime,.small{font-size:0.75rem}
}
</style>
</head>
<body>
<!-- User Info Modal -->
<div id="userModal">
  <div id="userModalContent">
    <h3>Enter Your Info</h3>
    <input id="modalIGN" type="text" placeholder="IGN" style="width:100%;margin-bottom:10px;padding:8px;border-radius:6px">
    <input id="modalGuild" type="text" placeholder="Guild" style="width:100%;margin-bottom:10px;padding:8px;border-radius:6px">
    <button id="modalSubmit" style="width:100%;padding:8px;border-radius:6px;background:var(--accent);color:#fff;font-weight:600">Submit</button>
  </div>
</div>

<div class="container" id="mainContent" style="display:none">
  <header>
    <div class="header-left">
      <strong>L9Boss Timers</strong>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="restartAll">Restart All</button>
        <button id="stopAll" class="ghost">Stop All</button>
        <button id="sendTimers">Send Timers</button>
        <button id="toggleTheme" class="ghost">Toggle Theme</button>
      </div>
    </div>
    <div class="header-right">
      <div id="userInfo" class="user-badge">IGN: — | Guild: —</div>
      <button id="changeUser" class="ghost">Change</button>
    </div>
  </header>
<main>
  <section>
    <h2>Manual Boss Timers</h2>
    <div style="margin-bottom:12px;display:flex;gap:6px;flex-wrap:wrap">
      <input id="manualName" type="text" placeholder="Boss Name">
      <input id="manualHours" type="number" placeholder="Hours">
      <button id="addManual">Add Manual Timer</button>
    </div>
    <div id="manualBossGrid" class="timer-grid"></div>
  </section>

  <section>
    <h2>Scheduled Bosses</h2>
    <div style="margin-bottom:12px;display:flex;gap:6px;flex-wrap:wrap">
      <input id="schedName" type="text" placeholder="Boss Name">
      <input id="schedTime" type="text" placeholder="Schedule e.g. mon 12:30,tue 15:00">
      <button id="addScheduled">Add Scheduled Boss</button>
    </div>
    <div id="scheduledBossGrid" class="timer-grid"></div>
  </section>

  <section>
    <h2>Recent Visitors (last 10 min)</h2>
    <div id="visitorLog">Loading...</div>
  </section>
</main>

<!-- Confirm Restart All Modal -->
<div id="confirmModal">
  <div id="confirmBox">
    <p>Restart all manual timers?</p>
    <label><input id="dontShowAgain" type="checkbox"> Don't ask again</label>
    <div style="margin-top:10px">
      <button id="confirmYes">Yes</button>
      <button id="confirmNo">No</button>
    </div>
  </div>
</div>
<!-- Firebase & Discord -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ---------- Firebase Setup ----------
const firebaseConfig = {
  apiKey: "AIzaSyAD5I3c-SZ2LRuYG_6kaMgEkjvOtP1d3pU",
  authDomain: "synchronizedtimer-57ef0.firebaseapp.com",
  databaseURL: "https://synchronizedtimer-57ef0-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "synchronizedtimer-57ef0",
  storageBucket: "synchronizedtimer-57ef0.appspot.com",
  messagingSenderId: "812068089886",
  appId: "1:812068089886:web:61e95179ca3ec2251e7e0f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------- Discord Webhooks ----------
const DISCORD_BOSS_WEBHOOK = "https://discord.com/api/webhooks/1418540875323150507/E1ojUFf1gBvgKs2O-GPm7XxCz6P4LVmCiBMIm3C8iyTrV957xlHOFTolet2OrcPEWPNL";
const DISCORD_VISITOR_WEBHOOK = "https://discord.com/api/webhooks/1418184593047289956/d0xJb2P_tDCDzmQXuBDj09s6S5qN5we22Ub6-1qJvnPrt99taW97zSZtYfGg9iccPWVe";

function sendBossDiscord(msg){
  fetch(DISCORD_BOSS_WEBHOOK,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ content: msg })
  }).catch(e=>console.error("Discord Boss error:",e));
}

function sendVisitorDiscord(msg){
  fetch(DISCORD_VISITOR_WEBHOOK,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ content: msg })
  }).catch(e=>console.error("Discord Visitor error:",e));
}

// ---------- User Info ----------
let userInfo = JSON.parse(localStorage.getItem("userInfo")) || null;
const mainContent = document.getElementById('mainContent');
const userModal = document.getElementById('userModal');
const modalIGN = document.getElementById('modalIGN');
const modalGuild = document.getElementById('modalGuild');
const modalSubmit = document.getElementById('modalSubmit');
const userInfoDisplay = document.getElementById('userInfo');
const changeUserBtn = document.getElementById('changeUser');

function showUserModal(){ userModal.style.display='flex'; mainContent.style.display='none'; }
function hideUserModal(){
  userModal.style.display='none';
  mainContent.style.display='block';
  if(userInfo && userInfo.user && userInfo.guild){
    userInfoDisplay.textContent = `IGN: ${userInfo.user} | Guild: ${userInfo.guild}`;
    applyGuildRestrictions();
  }
}

if(!userInfo || !userInfo.user || !userInfo.guild){ showUserModal(); } else { hideUserModal(); }

modalSubmit.addEventListener('click', ()=>{
  const ign = modalIGN.value.trim();
  const guild = modalGuild.value.trim();
  if(!ign || !guild){ alert('Both IGN and Guild are required'); return; }
  userInfo = { user: ign, guild: guild };
  localStorage.setItem('userInfo', JSON.stringify(userInfo));
  hideUserModal();
  logVisitor(userInfo.user, userInfo.guild);
});

changeUserBtn.addEventListener('click', ()=>{
  showUserModal();
  modalIGN.value = userInfo ? userInfo.user : '';
  modalGuild.value = userInfo ? userInfo.guild : '';
});

// ---------- Guild-Based Button Visibility ----------
function applyGuildRestrictions(){
  const isVesperial = userInfo.guild.toLowerCase() === 'vesperial';
  // Header buttons
  document.getElementById('restartAll').style.display = isVesperial ? 'inline-block':'none';
  document.getElementById('stopAll').style.display = isVesperial ? 'inline-block':'none';
  document.getElementById('sendTimers').style.display = isVesperial ? 'inline-block':'none';

  // Manual & Scheduled buttons
  document.querySelectorAll('.card').forEach(card=>{
    const stopBtn = card.querySelector('.stopBtn');
    const sendBtn = card.querySelector('.sendBtn');
    if(stopBtn) stopBtn.style.display = isVesperial ? 'inline-block':'none';
    if(sendBtn) sendBtn.style.display = isVesperial ? 'inline-block':'none';
  });
}
// ---------- Preloaded Manual Timers ----------
const preloadedManual = ["Venatus","Viorent","Ego","Levera","Araneo","Undomiel","Lady Dalia","General Aquleus","Amentis","Baron Braudmore","Wannitas","Metus","Duplican","Shuliar","Gareth","Titore","Larba","Catena"];
function normalize(s){ return s.replace(/\s+/g,'_').toLowerCase(); }

const manualDefs = preloadedManual.map(name=>({
  label: name,
  hours: { 'venatus':10,'viorent':10,'ego':21,'levera':24,'araneo':24,'undomiel':24,'lady_dalia':18,'general_aquleus':29,'amentis':29,'baron_braudmore':32,'wannitas':48,'metus':48,'duplican':48,'shuliar':35,'gareth':32,'titore':37,'larba':35,'catena':35 }[normalize(name)] || 24,
  id: 'manual_'+normalize(name),
  isCustom: false
}));

let startTimes = {};
let fixedTimersCache = {};
let bossMap = {};

// ---------- Preloaded Scheduled Timers ----------
const defaultFixedBosses = [
  { label: "Climantis", schedule: "mon 11:30,thu 19:00" },
  { label: "Saphirus", schedule: "sun 17:00,tue 11:30" },
  { label: "Neutro", schedule: "tue 19:00,thu 11:30" },
  { label: "Thymele", schedule: "mon 19:00,wed 11:30" },
  { label: "Milavy", schedule: "sat 15:00" },
  { label: "Ringor", schedule: "sat 17:00" },
  { label: "Roderick", schedule: "fri 19:00" },
  { label: "Auraq", schedule: "sun 21:00,wed 21:00" }
];
defaultFixedBosses.forEach(b=>{
  const key = 'default_'+normalize(b.label);
  db.ref('fixedTimers/'+key).get().then(snap=>{
    if(!snap.exists()) db.ref('fixedTimers/'+key).set(b);
  });
});

// ---------- Merge Timers ----------
function mergeTimers(){
  bossMap={};
  manualDefs.forEach(m=>{
    bossMap[m.label] = bossMap[m.label] || {};
    bossMap[m.label].label = m.label;
    bossMap[m.label].manual = m;
  });
  Object.values(fixedTimersCache).forEach(f=>{
    bossMap[f.label] = bossMap[f.label] || {};
    bossMap[f.label].label = f.label;
    bossMap[f.label].scheduled = f;
  });
}

// ---------- Create Cards ----------
function createBossCard(b, isManual=true){
  const card=document.createElement('div');
  card.className='card';
  card.dataset.label=b.label;
  const manualHours=b.manual ? b.manual.hours : null;
  const schedules=b.scheduled ? b.scheduled.schedule.split(',').map(s=>s.trim()) : [];
  const schedHtml=schedules.length ? `<div class="small">Schedule: ${schedules.join(', ')}</div>` : '';

  let buttonsHtml = '';
  if(isManual){
    buttonsHtml = `
      <div class="small endtime"></div>
      <button class="restartBtn">Restart (${manualHours}h)</button>
      <button class="stopBtn">Stop</button>
      ${b.manual.isCustom ? '<button class="deleteBtn">Delete</button>' : ''}
    `;
  }
  buttonsHtml += `<button class="sendBtn" style="margin-top:8px;">Send Timer</button>`;

  card.innerHTML=`
    <div class="label">${b.label}</div>
    <div class="clock">--:--:--</div>
    <div class="datetime"></div>
    ${buttonsHtml}
    ${schedHtml}
    <div class="small lastBy"></div>
  `;

  // Apply guild-based button visibility
  if(userInfo && userInfo.guild.toLowerCase() !== 'vesperial'){
    const stopBtn = card.querySelector('.stopBtn');
    const sendBtn = card.querySelector('.sendBtn');
    if(stopBtn) stopBtn.style.display='none';
    if(sendBtn) sendBtn.style.display='none';
  }

  return card;
}

function renderManualTimers(){
  const grid = document.getElementById('manualBossGrid');
  grid.innerHTML='';
  Object.values(bossMap).forEach(b=>{ if(b.manual) grid.appendChild(createBossCard(b)); });
  attachManualHandlers();
}

function renderScheduledTimers(){
  const grid = document.getElementById('scheduledBossGrid');
  grid.innerHTML='';
  Object.values(bossMap).forEach(b=>{ if(b.scheduled) grid.appendChild(createBossCard(b,false)); });
  attachScheduledHandlers();
}

function renderBossTimers(){
  renderManualTimers();
  renderScheduledTimers();
}
// ---------- Manual Timer Handlers ----------
function attachManualHandlers(){
  document.querySelectorAll('#manualBossGrid .card').forEach(card=>{
    const label = card.dataset.label;
    const manual = bossMap[label].manual;
    if(!manual) return;

    const restartBtn = card.querySelector('.restartBtn');
    const stopBtn = card.querySelector('.stopBtn');
    const deleteBtn = card.querySelector('.deleteBtn');
    const sendBtn = card.querySelector('.sendBtn');

    if(restartBtn && !restartBtn.dataset.bound){
      restartBtn.addEventListener('click', ()=>{
        const entry = { startedAt: Date.now(), user: userInfo.user, guild: userInfo.guild };
        db.ref('timers/'+manual.id).set(entry);
        db.ref('timerLogs/'+manual.id).push(entry);
        sendVisitorDiscord(`🟢 **${label}** restarted by **${userInfo.user} [${userInfo.guild}]**`);
      });
      restartBtn.dataset.bound='1';
    }

    if(stopBtn && !stopBtn.dataset.bound){
      stopBtn.addEventListener('click', ()=>{
        db.ref('timers/'+manual.id).set(null);
        sendBossDiscord(`⏹️ **${label}** timer stopped by **${userInfo.user} [${userInfo.guild}]**`);
      });
      stopBtn.dataset.bound='1';
    }

    if(deleteBtn && !deleteBtn.dataset.bound){
      deleteBtn.addEventListener('click', ()=>{
        if(confirm(`Delete manual timer for ${label}?`)){
          delete bossMap[label].manual;
          db.ref('timers/'+manual.id).set(null);
          renderManualTimers();
          sendBossDiscord(`🗑️ **${label}** manual timer deleted by **${userInfo.user} [${userInfo.guild}]**`);
        }
      });
      deleteBtn.dataset.bound='1';
    }

    if(sendBtn && !sendBtn.dataset.bound){
      sendBtn.addEventListener('click', ()=>{
        let endTimeText = '--:--';
        if(startTimes[manual.id]){
          const end = new Date(startTimes[manual.id].startedAt + manual.hours*3600*1000);
          endTimeText = `${end.toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short'})} ${end.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}`;
        }
        const msg = `@everyone\n🟢 **${label}**\nTime: ${endTimeText}\nBy: ${userInfo.user} [${userInfo.guild}]`;
        sendBossDiscord(msg);
      });
      sendBtn.dataset.bound='1';
    }
  });
}

// ---------- Scheduled Timer Handlers ----------
function attachScheduledHandlers(){
  document.querySelectorAll('#scheduledBossGrid .card').forEach(card=>{
    const label = card.dataset.label;
    const b = bossMap[label];
    if(!b || !b.scheduled) return;

    const sendBtn = card.querySelector('.sendBtn');
    if(sendBtn && !sendBtn.dataset.bound){
      sendBtn.addEventListener('click', ()=>{
        let nextTime = null;
        b.scheduled.schedule.split(',').forEach(s=>{
          const [day,time] = s.trim().split(' ');
          const occ = getNextOccurrence(day,time);
          if(!nextTime || occ < nextTime) nextTime = occ;
        });
        const endDate = nextTime ? new Date(nextTime) : null;
        const endTimeText = endDate ? `${endDate.toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short'})} ${endDate.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}` : '--:--';
        const msg = `@everyone\n🟢 **${label}**\nNext spawn: ${endTimeText}\nBy: ${userInfo.user} [${userInfo.guild}]`;
        sendBossDiscord(msg);
      });
      sendBtn.dataset.bound='1';
    }
  });
}

// ---------- Helper: Scheduled Boss ----------
function getNextOccurrence(dayStr, timeStr){
  const days = ['sun','mon','tue','wed','thu','fri','sat'];
  const now = new Date();
  const targetDay = days.indexOf(dayStr.toLowerCase());
  if(targetDay === -1) return now.getTime();
  const [hour, minute] = timeStr.split(':').map(Number);
  let dt = new Date(now);
  dt.setHours(hour, minute, 0, 0);
  let diff = targetDay - dt.getDay();
  if(diff < 0 || (diff === 0 && dt < now)) dt.setDate(dt.getDate() + 7 + diff);
  else dt.setDate(dt.getDate() + diff);
  return dt.getTime();
}

// ---------- Update Boss Clocks + 10-Min Notification ----------
const notified10Min = {}; // track which bosses have been notified

function updateBossClocks() {
  const now = Date.now();

  ['manualBossGrid','scheduledBossGrid'].forEach(gridId => {
    document.querySelectorAll(`#${gridId} .card`).forEach(card => {
      const label = card.dataset.label;
      const b = bossMap[label];
      const clockEl = card.querySelector('.clock');
      const datetimeEl = card.querySelector('.datetime');
      const lastByEl = card.querySelector('.lastBy');
      const endTimeEl = card.querySelector('.endtime');
      let remaining = null;

      // ---------- Manual Timers ----------
      if(b && b.manual) {
        const data = startTimes[b.manual.id];
        if(data && data.startedAt) {
          remaining = b.manual.hours*3600 - Math.floor((now - data.startedAt)/1000);

          // 10-minute notification exact second
          if(remaining === 600 && !notified10Min[b.manual.id]) {
            sendBossDiscord(`⏰ **${b.label}** will spawn in 10 minutes!`);
            notified10Min[b.manual.id] = true;
          } else if(remaining > 600) {
            notified10Min[b.manual.id] = false; // reset if timer restarted
          }
        } else {
          remaining = b.manual.hours*3600;
          notified10Min[b.manual.id] = false;
        }
      }

      // ---------- Scheduled Timers ----------
      if(b && b.scheduled) {
        let next = null;
        b.scheduled.schedule.split(',').forEach(s => {
          const [day,time] = s.trim().split(' ');
          const occ = getNextOccurrence(day,time);
          if(!next || occ < next) next = occ;
        });

        if(next) {
          const schedRemaining = Math.floor((next - now)/1000);

          // 10-minute notification exact second
          const schedKey = 'sched_' + b.label;
          if(schedRemaining === 600 && !notified10Min[schedKey]) {
            sendBossDiscord(`⏰ **${b.label}** will spawn in 10 minutes!`);
            notified10Min[schedKey] = true;
          } else if(schedRemaining > 600) {
            notified10Min[schedKey] = false;
          }

          if(remaining===null || schedRemaining<remaining) remaining = schedRemaining;
          const d = new Date(next);
          datetimeEl.textContent = `Next spawn: ${d.toLocaleDateString(undefined,{weekday:'short'})} ${d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}`;
        }
      }

      // ---------- Update Clock Display ----------
// ---------- Update Clock Display ----------
let isSameDay = false;
if (b && b.manual && startTimes[b.manual.id]) {
  const endDate = new Date(startTimes[b.manual.id].startedAt + b.manual.hours*3600*1000);
  isSameDay = new Date().toDateString() === endDate.toDateString();
}
if (b && b.scheduled) {
  let next = null;
  b.scheduled.schedule.split(',').forEach(s => {
    const [day,time] = s.trim().split(' ');
    const occ = getNextOccurrence(day,time);
    if (!next || occ < next) next = occ;
  });

  if (next) {
    const schedRemaining = Math.floor((next - now)/1000);

    if (remaining === null || schedRemaining < remaining) remaining = schedRemaining;

    const nextDate = new Date(next);
    isSameDay = new Date().toDateString() === nextDate.toDateString();
    datetimeEl.textContent = `Next spawn: ${nextDate.toLocaleDateString(undefined,{weekday:'short'})} ${nextDate.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}`;
  }
}

      if(remaining!==null){
        if(remaining<=0){
          remaining=0;
  card.classList.add('expired');          // red expired
  card.classList.remove('warning','timer-running','timer-today');
} else if (isSameDay) {
  // Ends today → green glow
  card.classList.add('timer-today');
  card.classList.remove('expired','warning','timer-running');
} else {
  // Active but not today → blue glow
  card.classList.add('timer-running');
  card.classList.remove('expired','warning','timer-today');
}

        const h=Math.floor(remaining/3600);
        const m=Math.floor((remaining%3600)/60);
        const s=remaining%60;
        clockEl.textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

        if(b && b.manual && startTimes[b.manual.id]){
          const endDate=new Date(startTimes[b.manual.id].startedAt + b.manual.hours*3600*1000);
          if(endTimeEl) endTimeEl.textContent = `Ends: ${endDate.toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short'})} ${endDate.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}`;
          lastByEl.textContent = `Last restart: ${startTimes[b.manual.id].user} [${startTimes[b.manual.id].guild}]`;
        }
      } else {
        clockEl.textContent='--:--:--';
        if(endTimeEl) endTimeEl.textContent='';
        lastByEl.textContent='';
        card.classList.remove('expired','warning');
      }
    });
  });
}
// ---------- Visitor Logging ----------
const visitorLogDiv = document.getElementById('visitorLog');
const VISITOR_COOLDOWN = 5*60*1000;

function logVisitor(user,guild){
  if(!user || !guild) return;
  const userKey = `${user}|${guild}`;
  const now = Date.now();
  const cooldownRef = db.ref('visitorCooldowns/'+userKey);
  const visitRef = db.ref('siteVisits').push();

  cooldownRef.get().then(snapshot=>{
    const lastTime = snapshot.val() || 0;
    const canSend = (now - lastTime) >= VISITOR_COOLDOWN;
    visitRef.set({user,guild,accessedAt:now});
    if(canSend){
      sendVisitorDiscord(`👀 New visitor: **${user} [${guild}]** visited the site!`);
      cooldownRef.set(now);
    }
  });
}

function loadVisitors(){
  const cutoff = Date.now() - 10*60*1000;
  db.ref('siteVisits').orderByChild('accessedAt').startAt(cutoff).once('value',snap=>{
    const visits = [];
    snap.forEach(c=>visits.push(c.val()));
    visits.sort((a,b)=>b.accessedAt - a.accessedAt);
    visitorLogDiv.innerHTML = visits.length ? '' : 'No recent visitors.';
    visits.forEach(v=>{
      const minutes = Math.floor((Date.now() - v.accessedAt)/60000);
      const d = document.createElement('div');
      d.textContent = `${v.user} [${v.guild}] - ${minutes} min ago`;
      visitorLogDiv.appendChild(d);
    });
  });
}

if(userInfo && userInfo.user && userInfo.guild){
  logVisitor(userInfo.user,userInfo.guild);
}
loadVisitors();
setInterval(loadVisitors,30000);

// ---------- Firebase Listeners ----------
manualDefs.forEach(m=>{
  db.ref('timers/'+m.id).on('value', snap => {
    startTimes[m.id] = snap.val();
    renderBossTimers();
  });
});

db.ref('fixedTimers').on('value', snap=>{
  fixedTimersCache = snap.val() || {};
  mergeTimers();
  renderBossTimers();
});

// ---------- Send All Timers ----------
const sendTimersBtn = document.getElementById('sendTimers');

if(userInfo && userInfo.guild.toLowerCase() !== 'vesperial'){
  sendTimersBtn.style.display='none';
  document.getElementById('restartAll').style.display='none';
  document.getElementById('stopAll').style.display='none';
}

sendTimersBtn.addEventListener('click', () => {
  let messages = [];

  // Manual Timers
  Object.values(bossMap).forEach(b => {
    if(b.manual){
      const data = startTimes[b.manual.id];
      let endTimeText = '--:--';
      if(data && data.startedAt){
        const end = new Date(data.startedAt + b.manual.hours*3600*1000);
        endTimeText = `${end.toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short'})} ${end.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}`;
      }
      messages.push(`🟢 **${b.label}**\nTime: ${endTimeText}`);
    }
  });

  // Scheduled Timers
  Object.values(bossMap).forEach(b => {
    if(b.scheduled){
      let nextTime = null;
      b.scheduled.schedule.split(',').forEach(s=>{
        const [day,time] = s.trim().split(' ');
        const occ = getNextOccurrence(day,time);
        if(!nextTime || occ < nextTime) nextTime = occ;
      });
      const endDate = nextTime ? new Date(nextTime) : null;
      const endTimeText = endDate ? `${endDate.toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short'})} ${endDate.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}` : '--:--';
      messages.push(`🟢 **${b.label}**\nNext spawn: ${endTimeText}`);
    }
  });

  if(messages.length){
    const fullMsg = `@everyone\n` + messages.join('\n\n');
    sendBossDiscord(fullMsg);
  }
});

// ---------- Auto Update Clocks ----------
setInterval(updateBossClocks,1000);
</script>
<script>
function renderBossTimers(){
  renderManualTimers();
  renderScheduledTimers();
  refreshSendPanel(); // ✅ keep panel updated
}

function applyGuildRestrictions() {
  const guild = localStorage.getItem('guild') || '';
  const isVesperial = guild.toLowerCase() === 'vesperial';

  // Hide send buttons if not vesperial
  document.querySelectorAll('.sendBtn').forEach(btn => {
    btn.style.display = isVesperial ? 'inline-block' : 'none';
  });

  // ✅ Also hide bottom panel
  document.getElementById('sendPanel').style.display = isVesperial ? 'block' : 'none';
}
</script>

<!-- Collapsible Send Panel -->
<div id="sendPanel" style="position:none;bottom:0;left:0;right:0;background:var(--card-bg);border-top:1px solid rgba(255,255,255,0.1);padding:10px;box-shadow:0 -4px 12px rgba(0,0,0,0.4);z-index:9999;">
  <div id="sendPanelHeader" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
    <strong>📤 Send Selected Timers</strong>
    <span id="toggleSendPanel" style="font-weight:700;cursor:pointer;">▲</span>
  </div>
  <div id="sendPanelContent" style="margin-top:10px;max-height:250px;overflow-y:auto;">
    <div id="sendPanelTimers" style="display:flex;flex-direction:column;gap:6px;"></div>
    <textarea id="customMessage" placeholder="Optional message..." style="margin-top:10px;width:100%;padding:6px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--fg);"></textarea>
    <button id="sendSelected" style="margin-top:10px;width:100%;">Send Selected</button>
  </div>
</div>

<script>
// --- Collapsible Panel Logic ---
const sendPanelContent = document.getElementById('sendPanelContent');
const toggleSendPanel = document.getElementById('toggleSendPanel');
let sendPanelOpen = true;

toggleSendPanel.addEventListener('click', () => {
  sendPanelOpen = !sendPanelOpen;
  sendPanelContent.style.display = sendPanelOpen ? 'block' : 'none';
  toggleSendPanel.textContent = sendPanelOpen ? '▲' : '▼';
});

// --- Populate Timers into Panel ---
function refreshSendPanel(){
  const container = document.getElementById('sendPanelTimers');
  container.innerHTML = '';
  Object.values(bossMap).forEach(b=>{
    const div=document.createElement('div');
    div.innerHTML=`<label><input type="checkbox" value="${b.label}"> ${b.label}</label>`;
    container.appendChild(div);
  });
}

// --- Send Selected ---
document.getElementById('sendSelected').addEventListener('click', ()=>{
  const selected = Array.from(document.querySelectorAll('#sendPanelTimers input:checked')).map(i=>i.value);
  const customMsg = document.getElementById('customMessage').value.trim();
  if(!selected.length){ alert("Select at least one timer."); return; }

  let messages=[];
  selected.forEach(label=>{
    const b = bossMap[label];
    if(!b) return;

    if(b.manual){
      const data = startTimes[b.manual.id];
      let endTimeText='--:--';
      if(data && data.startedAt){
        const end = new Date(data.startedAt + b.manual.hours*3600*1000);
        endTimeText = `${end.toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short'})} ${end.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}`;
      }
      messages.push(`🟢 **${label}**\nTime: ${endTimeText}`);
    }

    if(b.scheduled){
      let nextTime=null;
      b.scheduled.schedule.split(',').forEach(s=>{
        const [day,time] = s.trim().split(' ');
        const occ = getNextOccurrence(day,time);
        if(!nextTime || occ < nextTime) nextTime = occ;
      });
      const endDate=nextTime ? new Date(nextTime):null;
      const endTimeText = endDate ? `${endDate.toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short'})} ${endDate.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}` : '--:--';
      messages.push(`🟢 **${label}**\nNext spawn: ${endTimeText}`);
    }
  });

  if(messages.length){
    let fullMsg = `@everyone\n`+messages.join('\n\n');
    if(customMsg) fullMsg += `\n\n💬 ${customMsg}`;
    sendBossDiscord(fullMsg);
  }
});
</script>
</body>
</html>